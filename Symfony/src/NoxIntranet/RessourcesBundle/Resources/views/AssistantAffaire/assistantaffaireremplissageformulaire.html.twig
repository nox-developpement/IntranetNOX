{% extends "::layout.html.twig" %}

{% block titrePage %} Edition de feuille de suivi {% endblock %}

{% block messageAccueil %}Edition de feuille de suivi - {{ suivi.Nom }}{% endblock %}

{% block contenu %}

    <div id='DivFormulaireSelectionVersionSuivi'>

        {{ form_start(formSelectionVersionSuivi, {'attr': {'class': 'formulaireSelectionVersionSuivi'}}) }}
        {{ form_errors(formSelectionVersionSuivi) }}

        <fieldset>

            <legend>Version</legend>

            {{ form_label(formSelectionVersionSuivi.version, "Selection de la version :", {'label_attr': {'class': 'labelFormulaireSelectionVersionSuivi'}}) }}
            {{ form_errors(formSelectionVersionSuivi.version) }}
            {{ form_widget(formSelectionVersionSuivi.version, {'attr': {'class': 'selectFormulaireSelectionVersionSuivi'}}) }}

            {{ form_widget(formSelectionVersionSuivi.Supprimer, {'attr': {'class': 'boutonFormulaire' }}) }}

        </fieldset>

        {{ form_end(formSelectionVersionSuivi) }}

    </div>

    <div id="DivFormulaireCloturationSuivi">

        {{ form_start(formCloturationSuivi, {'attr': {'class': 'formulaireCloturationSuivi'}}) }}
        {{ form_errors(formCloturationSuivi) }}

        <fieldset>

            <legend>Cloturation</legend>

            {{ form_widget(formCloturationSuivi.Cloturer, {'label': 'Cloturer le suivi', 'attr': {'class': 'boutonFormulaire'}}) }}

        </fieldset> 

        {{ form_widget(formCloturationSuivi._token) }}
        {{ form_end(formCloturationSuivi) }}
    </div>

    <div id="DivInfoSuivi">

        <form class="formInfo">
            <fieldset>
                <legend>Infos suivi</legend>

                <label>Agence: </label><input type='text' value='{{ suivi.Agence }}' readonly><br />
                <label>NumÃ©ro GX: </label><input type='text' value='{{ suivi.NumeroGX }}' readonly><br />
                <label>Commune: </label><input type='text' value='{{ suivi.Commune }}' readonly><br />
                <label>MarchÃ©: </label><input type='text' value='{{ suivi.Marche }}' readonly><br />
                <label>NÂ° Client: </label><input type='text' value='{{ suivi.NoClient }}' readonly><br />
                <label>Objet: </label><input type='text' value='{{ suivi.Objet }}' readonly><br />
                <label>NÂ° INGEDIA BEP: </label><input type='text' value='{{ suivi.NoINGEDIABEP }}' readonly><br />
                <label>Estimatif: </label><input type='text' value='{{ suivi.Estimatif }}' readonly><br />
                <label style="border-bottom: 1px dotted #1F4E79;">Client: </label><input id='clientPopupOpener' type='text' value='{{ client.NomCLient }}' readonly><br />
                <label>Interlocuteur: </label><input type='text' value='{{ interlocuteur.PrenomContact }} {{ interlocuteur.NomContact }}' readonly><br />
                {% for nCommandeKey, nCommande in suivi.NoCommande %}
                    <p id="{{ nCommandeKey }}" class="noCommande">
                        NÂ° de Commande {{ loop.index }}: <span contenteditable="true" style='white-space: nowrap;'>{{ nCommande }}</span>
                        {% if suivi.NoCommande|length > 1 %}
                            <img src="{{ asset('bundles/noxintranetressources/images/Minus-32.png') }}" style="text-align: center; vertical-align: bottom; height: 1.2em; margin-left: 0.1em;" onclick="deleteNoCommande('{{ nCommandeKey }}');"/>
                        {% endif %}
                        {% if loop.last %}
                            <img src="{{ asset('bundles/noxintranetressources/images/Add-New-32.png') }}" style="text-align: center; vertical-align: bottom; height: 1.2em; margin-left: 0.1em;" onclick="addNoCommande('{{ nCommandeKey }}', {{ loop.index }});"/>
                        {% endif %}
                    </p>
                {% endfor %} 
            </fieldset>
        </form>

    </div>

    <div id="DivFormulaireRemplissageSuivi" style="margin-bottom: 5%;">

        {{ form_start(formDonneesSuivi, {'attr': {'class': 'formulaireRemplissageSuivi'}}) }}
        {{ form_errors(formDonneesSuivi) }}

        <fieldset>

            <legend>{{ suivi.Nom }}</legend>

            {% for champ in champsViews %}
                {{ form_errors(attribute(formDonneesSuivi, champ.Champ)) }}
            {% endfor %}

            <p>
                {% for champ in champsViews %}
                    {{ form_label(attribute(formDonneesSuivi, champ.Champ), champ.Nom ~ " : ", {'label_attr': {'class': 'labelFormulaireRemplissageSuivi'}}) }}   
                    {{ form_widget(attribute(formDonneesSuivi, champ.Champ)) }}
                    <br />

                    {% if champ.Type == 'Nombre' %}
                        <script>
                            var fax = document.getElementById('formDonneesSuivi_{{ champ.Champ }}');
                            var phoneRegex = new RegExp(/^[-+]?[0-9]*\.?[0-9]+$/);
                            var checkValidPhoneNumber = function () {
                                if (!phoneRegex.test(fax.value)) {
                                    fax.style.borderColor = 'red';
                                    fax.setCustomValidity("Veuillez entrer un nombre. Les dÃ©cimaux doivent Ãªtre sÃ©parÃ© par un point.");
                                } else {
                                    fax.style.borderColor = 'initial';
                                    fax.setCustomValidity('');
                                }
                            };
                            $('#formDonneesSuivi_{{ champ.Champ }}').keyup(function () {
                                checkValidPhoneNumber();
                            });
                        </script>
                    {% endif %}

                {% endfor %}

                {{ form_widget(formDonneesSuivi.Generate, {'label': 'GÃ©nÃ©rer fichier Excel', 'attr': {'class': 'boutonFormulaire' }}) }}
                {{ form_widget(formDonneesSuivi.Save, {'label': 'Sauvegarder le suivi', 'attr': {'class': 'boutonFormulaire'}}) }}

            </p>
        </fieldset> 

        {{ form_end(formDonneesSuivi) }}
    </div>

    <script>
        $(document).ready(function () {
            resizeFormLabelAndData($('.labelFormulaireRemplissageSuivi'), $('.champFormulaireRemplissageSuivi'), $('.formulaireRemplissageSuivi p'));
            hideAndShowDataAdding();
            ApplyBlurFunction();
            openClientPopup();
        });

        function addNoCommande(nbNoCommande, loopIndex) {
            if ($('#' + nbNoCommande + ' span').text() !== '') {
                var newNoCommande = "<p id='" + (parseInt(nbNoCommande) + 1) + "' class='noCommande'> NÂ° de Commande " + (loopIndex + 1) + ": <span contenteditable='true' style='white-space: nowrap;'></span><img src={{ asset('bundles/noxintranetressources/images/Add-New-32.png') }} style='text-align: center; vertical-align: bottom; height: 1.2em; margin-left: 0.5em;' onclick='addNoCommande(" + (parseInt(nbNoCommande) + 1) + "," + (loopIndex + 1) + ");' /></p>";
                $('#' + nbNoCommande).after(newNoCommande);
                $('#' + nbNoCommande + ' img').remove();
                ApplyBlurFunction();
                updateNoCommandeButton(nbNoCommande, loopIndex);
            } else {
                $('#' + nbNoCommande + ' span').focus();
            }
        }

        function EditNoCommande(context) {
            if ($('#' + context.attr('id') + ' span').text() !== '') {
                ajaxSaveNoCommande(context.attr('id'), $('#' + context.attr('id') + ' span').text());
            }
        }

        function deleteNoCommande(context) {
            $('#' + context).remove();
            ajaxDeleteNoCommande(context);
            updateNoCommandeButton($('.noCommande').last().attr('id') - 1, $('.noCommande').length);
        }

        function ApplyBlurFunction() {
            $('.noCommande').each(function () {
                $(this).keypress(function (e) {
                    if (e.which === 13) {
                        e.preventDefault();
                        $('#' + $(this).attr('id')).removeAttr('contenteditable');
                        EditNoCommande($(this));
                    }
                });
                $(this).focusout(function () {
                    EditNoCommande($(this));
                });
            });
        }

        function updateNoCommandeButton(key, loopIndex) {

            var reg = /(NÂ° de Commande [0-9]{1,}:)/;

            $('.noCommande').find('img').remove();
            if ($('.noCommande').length > 1) {
                $('.noCommande').each(function (index) {
                    $(this).html($(this).html().replace(reg, "NÂ° de Commande " + (index + 1) + ":"));
                    $(this).find('span').after("<img src='{{ asset('bundles/noxintranetressources/images/Minus-32.png') }}' style='text-align: center; vertical-align: bottom; height: 1.2em; margin-left: 0.1em;' onclick='deleteNoCommande(" + $(this).attr('id') + ");'/>");
                });
            }
            $('.noCommande').last().append("<img src='{{ asset('bundles/noxintranetressources/images/Add-New-32.png') }}' style='text-align: center; vertical-align: bottom; height: 1.2em; margin-left: 0.1em;' onclick=\"addNoCommande('" + (parseInt(key) + 1) + "'," + (loopIndex + 1) + ");\"/>");
        }

        function ajaxDeleteNoCommande(context2) {
            $.ajax({
                type: 'POST',
                url: '{{ path('nox_intranet_assistant_affaire_ajax_nocommande_delete') }}',
                data: {suiviId2: '{{ suivi.Id }}', idNoCommande2: context2}
            });
        }

        function ajaxSaveNoCommande(context, value) {
            $.ajax({
                type: 'POST',
                url: '{{ path('nox_intranet_assistant_affaire_ajax_nocommande_save') }}',
                data: {suiviId: '{{ suivi.Id }}', idNoCommande: context, noCommandeValue: value}
            });
        }

        // Ouvre un fenêtre pop-up contenant les informations sur le client.
        function openClientPopup() {

            //<span class="tooltipClient">{% if clientAdr != null %}<span class="tooltipClientText"><span class="tooltipTag">TÃ©lÃ©phone</span>: {{ clientAdr.Tel }}<br /><span class="tooltipTag">Fax</span>: {{ clientAdr.Fax }}<br /><span class="tooltipTag">Email</span>: {{ clientAdr.Email }}<br /><span class="tooltipTag">Ville</span>: {{ clientAdr.NomVille }}<br /><span class="tooltipTag">Pays</span>: {{ clientAdr.NomPays }}<br /><span class="tooltipTag">Adresse</span>: {{ clientAdr.Adresse1 }} {{ clientAdr.Adresse2 }} {{ clientAdr.Adresse3 }}</span>{% endif %}</span>


            $('#clientPopupOpener').click(function () {
                alert('test');
                var newwindow = window.open('Information client', '', 'height=200,width=150');
                newwindow.document.write('text');
                if (window.focus) {
                    newwindow.focus();
                }
                return false;
            });
        }

    </script>

{% endblock %}
