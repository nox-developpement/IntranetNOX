{% extends "layout.html.twig" %}

{% block titrePage %} Assistant(e) agence: Validation pointages {% endblock %}

{% block messageAccueil %}Assistant(e) agence: Validation pointages{% endblock %}

{% block contenu %}
    <div id="pointageSelection">

        {{ form_start(form) }}
        {{ form_errors(form) }}
        <fieldset>
            <legend>Séléction de pointage</legend>

            <div>
                {{ form_label(form.User, 'Utilisateur') }} <br />
                <input type="text" id="pointerUserSearch" placeholder="Rechercher un utilisateur">
                {{ form_errors(form.User) }}
                {{ form_widget(form.User) }}
            </div><!--
    
            --><div>
                {{ form_label(form.Month, 'Mois') }} <br />
                {{ form_errors(form.Month) }}
                {{ form_widget(form.Month) }}
            </div><!--
    
            --><div>
                {{ form_label(form.Year, 'Année') }} <br />
                {{ form_errors(form.Year) }}
                {{ form_widget(form.Year) }}
            </div>
        </fieldset>
        {{ form_end(form) }}

        {{ form_start(formToCheckPointage) }}
        {{ form_errors(formToCheckPointage) }}
        <fieldset>
            <legend>Pointage en attente de validation</legend>

            <div>
                {{ form_errors(formToCheckPointage.Pointage) }}
                {{ form_widget(formToCheckPointage.Pointage) }}
            </div>
        </fieldset>
        {{ form_end(formToCheckPointage) }}
    </div>

    <div id="pointageStatusDiv">
        <div id="pointageStatusLabelGeneralContainer">
            <div class='pointageStatusLabelContainer'><p class='pointageStatusLabel'>Collaborateur</p></div><!--
            --><div class='pointageStatusLabelContainer'><p class='pointageStatusLabel'>Assistant(e) agence</p></div><!--
            --><div class='pointageStatusLabelContainer'><p class='pointageStatusLabel'>DA/Manager</p></div><!--
            --><div class='pointageStatusLabelContainer'><p class='pointageStatusLabel'>Assistant(e) RH/DRH</p></div><!--
            --><div class='pointageStatusLabelContainer'><p class='pointageStatusLabel'>Validé</p></div><!--
            --></div>
        <div id="pointageStatus">
            <div class='pointageStatusCircleContainer'><div class='pointageStatusCircle' step=0></div></div><!--
            --><div class='pointageStatusCircleContainer'><div class='pointageStatusCircle' step=1></div></div><!--
            --><div class='pointageStatusCircleContainer'><div class='pointageStatusCircle' step=2></div></div><!--
            --><div class='pointageStatusCircleContainer'><div class='pointageStatusCircle' step=3></div></div><!--
            --><div class='pointageStatusCircleContainer'><div class='pointageStatusCircle' step=4></div></div>
            <div class='pointageStatusLine'><div></div></div>
        </div>
    </div>

    <div id='tableFeuillePointageDivContainer'>
        <table id="tableFeuillePointage">
            <tr>
                <td style="border: solid 1px black;">
                    <select id='pointage_month_selector' style="width: 100%;">
                        {% set months = { 01: 'Janvier', 02: 'Février', 03: 'Mars', 04: 'Avril', 05: 'Mai', 06: 'Juin', 07: 'Juillet', 08: 'Août', 09: 'Septembre', 10: 'Octobre', 11: 'Novembre', 12: 'Décembre' } %}
                        {% for index,month in months %}
                            <option value="{{ index }}" {% if index == currentMonth %}selected{% endif %}>{{ month }}</option>  
                        {% endfor %}
                    </select>
                </td>
                <td id='operationnel' style="background: rgb(47,117,181); color: white; border-width: 1px;" colspan="2">OPERATIONNEL <p id="addProject" style="margin: 0; float: right; display: inline-block; cursor: pointer;">+ Affaire</p></td>
                <td style="background: black; border-width: 1px;"></td>
                <td style="background: rgb(84,130,53); color: white; border-width: 1px;" colspan="5">RESSOURCES HUMAINES</td>
                <td style="border: none; border-bottom: solid 1px black;" ></td>
            </tr>
            <tr>
                <td style="border: solid 1px black;">
                    <select id='pointage_year_selector' style="width: 100%;">
                        <option value="{{ 'now'|date('Y')}}">{{ 'now'|date('Y')}}</option>
                        <option value="{{ 'now'|date_modify('+1 year')|date('Y')}}">{{ 'now'|date_modify('+1 year')|date('Y')}}</option>
                        <option value="{{ 'now'|date_modify('+2 year')|date('Y')}}">{{ 'now'|date_modify('+2 year')|date('Y')}}</option>
                        <option value="{{ 'now'|date_modify('+3 year')|date('Y')}}">{{ 'now'|date_modify('+3 year')|date('Y')}}</option>
                        <option value="{{ 'now'|date_modify('+4 year')|date('Y')}}">{{ 'now'|date_modify('+4 year')|date('Y')}}</option>
                    </select>
                </td>
                <td class='project' style='border-left-width: 1px; border-top-width: 1px; border-bottom-width: 1px;' contenteditable=true>Nouvelle Affaire<img src='{{ asset('bundles/noxintranetpointage/images/Delete-24.png') }}' alt='Supprimer projet'></td>
                <td style='border-width: 1px;'>TOTAL</td>
                <td style='border-width: 1px;' >MOD</td>
                <td style='border-width: 1px;' colspan="2">Absences</td>
                <td style='border-width: 1px;' >Titres repas</td>
                <td style='border-width: 1px;' >Forfaits déplacement</td>
                <td style='border-width: 1px;' >Primes panier</td>
                <td style='border-width: 1px;' rowspan="2" >Commentaires</td>
            </tr>
            <tr>
                <td style="background: rgb(217,217,217); border-width: 1px;"></td>
                <td class='project' style='border-left-width: 1px; border-top-width: 1px; border-bottom-width: 1px;'>%</td>
                <td style='border-width: 1px;'>%</td>
                <td style='border-width: 1px;' >h</td>
                <td style='border-width: 1px;'>Matin</td>
                <td style='border-width: 1px;'>Après-midi</td>
                <td style='border-width: 1px;'>Nombre</td>
                <td style='border-width: 1px;'>Montant</td>
                <td style='border-width: 1px;'>Nombre</td>
            </tr>
            {% set frenchDays = { 'Monday': 'Lundi', 'Tuesday': 'Mardi', 'Wednesday': 'Mercredi', 'Thursday': 'Jeudi', 'Friday': 'Vendredi', 'Saturday': 'Samedi', 'Sunday':'Dimanche' } %}
            {% for date in monthDates %}
                <tr>
                    <td class='dayDateCell' style="{% if date|date('l') == 'Saturday' or date|date('l') == 'Sunday' or date in joursFeries %} background:rgb(166,166,166); {% endif %} border-left-width: 1px; border-right-width: 1px;">{{ frenchDays[date|date('l')]}} {{ date|date('d') }}</td>
                    <td class="projectPercentageCell project" {% if date|date('l') == 'Saturday' or date|date('l') == 'Sunday' or date in joursFeries %} style="background:rgb(166,166,166);" {% else %} contenteditable='true' {% endif %}></td>
                    <td class="dailyTotalPercentageCell" style="{% if date|date('l') == 'Saturday' or date|date('l') == 'Sunday' or date in joursFeries %} background:rgb(166,166,166); {% endif %} border-left-width: 1px; border-right-width: 1px;">
                        {% if date|date('l') != 'Saturday' and date|date('l') != 'Sunday' and date not in joursFeries %}
                            0.00
                        {% endif %}
                    </td>
                    <td class='dailyHoursMod' {% if date|date('l') == 'Saturday' or date|date('l') == 'Sunday' or date in joursFeries %} style="background:rgb(166,166,166); border-left-width: 1px; border-right-width: 1px;" {% else %} contenteditable='true' style="border-left-width: 1px; border-right-width: 1px;" {% endif %}></td>
                    <td class='abscenceMatinSelector' style="{% if date|date('l') == 'Saturday' or date|date('l') == 'Sunday' or date in joursFeries %} background:rgb(166,166,166); {% endif %} border-left-width: 1px;">
                        {% if date|date('l') != 'Saturday' and date|date('l') != 'Sunday' and date not in joursFeries %}
                            <select>
                                <option value=''></option>
                                <option value='AA'>AA</option>
                                <option value='TJ'>TJ</option>
                                <option value='AT'>AT</option>
                                <option value='MT'>MT</option>
                                <option value='PA'>PA</option>
                                <option value='CS'>CS</option>
                                <option value='CP'>CP</option>
                                <option value='AV'>AV</option>
                                <option value='JS'>JS</option>
                                <option value='MA'>MA</option>
                                <option value='PM'>PM</option>
                                <option value='RE'>RE</option>
                                <option value='Autre'>Autre</option>
                            </select>
                        {% endif %}
                    </td>
                    <td  class='abscenceAMSelector' style="{% if date|date('l') == 'Saturday' or date|date('l') == 'Sunday' or date in joursFeries %} background:rgb(166,166,166); {% endif %} border-right-width: 1px;">
                        {% if date|date('l') != 'Saturday' and date|date('l') != 'Sunday' and date not in joursFeries %}
                            <select>
                                <option value=''></option>
                                <option value='AA'>AA</option>
                                <option value='TJ'>TJ</option>
                                <option value='AT'>AT</option>
                                <option value='MT'>MT</option>
                                <option value='PA'>PA</option>
                                <option value='CS'>CS</option>
                                <option value='CP'>CP</option>
                                <option value='AV'>AV</option>
                                <option value='JS'>JS</option>
                                <option value='MA'>MA</option>
                                <option value='PM'>PM</option>
                                <option value='RE'>RE</option>
                                <option value='Autre'>Autre</option>
                            </select>
                        {% endif %}
                    </td>
                    <td class='titreRepasNumberSelector' style="{% if date|date('l') == 'Saturday' or date|date('l') == 'Sunday' or date in joursFeries %} background:rgb(166,166,166); {% endif %} border-left-width: 1px; border-right-width: 1px;">
                        {% if date|date('l') != 'Saturday' and date|date('l') != 'Sunday' and date not in joursFeries %}
                            <select>
                                <option value=''></option>
                                <option value='1'>1</option>
                            </select>
                        {% endif %}
                    </td>
                    <td class='forfaitsDeplacementMontant' {% if date|date('l') == 'Saturday' or date|date('l') == 'Sunday' or date in joursFeries %} style="background:rgb(166,166,166);  border-left-width: 1px; border-right-width: 1px;" {% else %} style="border-left-width: 1px; border-right-width: 1px;" contenteditable=true {% endif %}></td>
                    <td class='primesPanierNumber' {% if date|date('l') == 'Saturday' or date|date('l') == 'Sunday' or date in joursFeries %} style="background:rgb(166,166,166);  border-left-width: 1px; border-right-width: 1px;" {% else %} style="border-left-width: 1px; border-right-width: 1px;" contenteditable=true {% endif %}></td>
                    <td class='comments' style="border-left-width: 1px; border-right-width: 1px;" contenteditable=true></td>
                </tr>        
            {% endfor %}
            <tr>
                <td style='border: none;'></td>
                <td style='border: none;' ></td>
                <td style='border: none;'></td>
                <td style='border: none;'></td>
                <td style='border: none;'></td>
                <td style='border: none; border-right: solid 1px;'></td>
                <td id='titreRepasTotalNumber' style="border-width: 2px; border-top: none; border-right-width: 1px; border-left-width: 1px;">0</td>
                <td id='ForfaitDeplacementTotalMontant' style="border-width: 2px; border-top: none; border-left-width: 1px; border-right-width: 1px;">0</td>
                <td id='PrimesPanierTotalNumber' style="border-width: 2px; border-top: none; border-left-width: 1px; border-right-width: 1px">0</td>
                <td style='border: none; border-left: solid 1px black;'></td>    
            </tr>
            <tr>
                <td style='border: none;'></td>
                <td class='monthlyTotalPercentageCell' style='border: none; color: white;'></td>
                <td style='border: none;'></td>
                <td id='monthlyTotalHoursMod' style='border-bottom: none;'>0</td>
                <td style='border: none;'></td>
                <td style='border: none;'></td>
                <td style='border: none;'></td>
                <td style='border: none;'></td>
                <td style='border: none;'></td>    
                <td style='border: none;'></td>    
            </tr>
            <tr>
                <td style='border: none;'></td>
                <td class='monthlyTotalCell' style='border: none; color: white;'></td>
                <td style='border: none;'></td>
                <td style='border-bottom: none;'>hmod</td>
                <td style='border: none;'></td>
                <td style='border: none;'></td>
                <td style='border: none;'></td>
                <td style='border: none;'></td>
                <td style='border: none;'></td>    
                <td style='border: none;'></td>    
            </tr>
        </table>
        <div id='ajaxSearchAffairesDiv' style='position: absolute; top: 0; left: 0; background-color: white; border: 1px solid rgb(165, 172, 178); font-size: 0.8vw; display: none;'>
        </div>
        <div id='projectDeleteMenu'>
            <img src='{{ asset('bundles/noxintranetpointage/images/Delete-24.png') }}' alt='Supprimer projet'><p>Supprimer cette affaire</p>
        </div>
    </div>
    <div id='tableFeuillePointageTypesAbscencesDivContainer'>
        <table id='tableFeuillePointageTypesAbscences'>
            <tr>
                <td colspan=3 style='border-width: 2px;'>Types d'absences</td>
            </tr>
            <tr>
                <td style='border-top-width: 2px; border-left-width: 2px; border-bottom-width: 2px;'>Nombre</td>
                <td style='border-top-width: 2px; border-bottom-width: 2px;'>Code absence</td>
                <td style='border-top-width: 2px; border-right-width: 2px; border-bottom-width: 2px;'>Type absence</td>
            </tr>
            {% set typesAbscences = { 'AA': 'Absence autorisées payées', 'TJ': 'Accident trajet', 'AT': 'Accident travail', 'MT': 'Congé de maternité', 
            'PA': 'Congé de paternité', 'CS': 'Congé sans solde', 'CP': 'Congés payés', 'AV': 'Evènement familial', 'JS': 'RTT', 'MA': 'Maladie', 'PM': 'Maladie professionnelle', 
            'RE': 'Récupération (non indiquée au bulletin)', 'Autre': 'A préciser en commentaire' } 
            %}

            {% for code, type in typesAbscences %}
                <tr>
                    <td class='nbAbscences' style='border-left-width: 2px; {% if loop.last %} border-bottom-width: 2px; {% endif %}'>0</td>
                    <td  {% if loop.last %} style='border-bottom-width: 2px;' {% endif %}>{{ code}}</td>
                    <td style='border-right-width: 2px; {% if loop.last %} border-bottom-width: 2px; {% endif %}'>{{ type }}</td>
                </tr>
            {% endfor %}
        </table>

        <table id='tableFeuillePointageTitreTransport'>
            <tr>
                <td colspan='2' style='border-width: 2px;'>Titre de transport</td>
            </tr>
            <tr>
                <td style='border-width: 2px;'>Montant total</td>
                <td style='border-width: 2px;'>Prise en charge employeur 50%*</td>
            </tr>
            <tr>
                <td id='titreTransportMontant' style='border-width: 2px;' contenteditable=true></td>
                <td id='titreTransportTotalMontant' style='border-width: 2px;'>0.00</td>
            </tr>
        </table>

        <table id='tableFeuillePointageSignature'>
            <tr>
                <td style='border-width: 2px;'>Signature collaborateur</td>
                <td id='signatureCollaborateur' colspan=2 style='border-width: 2px;' contenteditable=true></td>
            </tr>
            <tr>
                <td rowspan=2 style='border-width: 2px;'>Signature supérieur hiérarchique</td>
                <td style='border-width: 2px; width: 50%; border-right: none;'>Nom et prénom:</td>
                <td style='border-width: 2px; width: 50%; border-left: none;' contenteditable=true></td>
            </tr>
            <tr>
                <td colspan=2 style='border-width: 2px; height: 2vw;' contenteditable=true></td>
            </tr>
        </table>

        <form action="#">
            <div>
                <button type="button" id="form_Valider" name="form[Valider]" class="boutonCompilation">Valider la feuille de pointage</button>
            </div>
        </form>
    </div>

    <script>
        $(window).load(function () {
            IECheck();
            hidePointageTables();
            $('#form_User').change(function () {
                ajaxGetMonthByUsername();
            });
            $('#form_Month').change(function () {
                ajaxGetYearByMonthAndUsername();
            });
            $("#pointerUserSearch").on("keyup paste", function () {
                ajaxUsernameSearch();
            });
            getNewDate();
            displayDailyProjectsTotalPercentage();
            dispayMonthlyTotalHoursMod();
            displayMonthlyTotalTitresRepas();
            displayMonthlyTotalForfaitsDeplacement();
            displayMonthlyTotalPrimesPanier();
            displayTotalAbscences();
            displayTotalTitreTransport();
            checkAbscencesTitreRepas();
            onePerkOnly();
            getGXAffaires();
            showAffaireName();
            addProjectColumn();
            deleteProjectColumn();
        });

        // Cache les tables de la feuille de pointage.
        function hidePointageTables() {
            $('#tableFeuillePointageDivContainer td[contenteditable=true], #tableFeuillePointageTypesAbscencesDivContainer td[contenteditable=true]').unbind('blur');
            $('#tableFeuillePointageDivContainer select:not(#pointage_month_selector, #pointage_year_selector), #tableFeuillePointageTypesAbscencesDivContainer select:not(#pointage_month_selector, #pointage_year_selector)').unbind('change');
            $('#tableFeuillePointageDivContainer').hide();
            $('#tableFeuillePointageTypesAbscencesDivContainer').hide();
            $('#form_User, #form_Month, #form_Year, #form_Pointage').change(function () {
                if ($('#form_User option:selected').val() === '' || $('#form_Month option:selected').val() === '' || $('#form_Year option:selected').val() === '' || $('#form_Pointage option:selected')) {
                    $('#tableFeuillePointageDivContainer td[contenteditable=true], #tableFeuillePointageTypesAbscencesDivContainer td[contenteditable=true]').unbind('blur');
                    $('#tableFeuillePointageDivContainer select:not(#pointage_month_selector, #pointage_year_selector), #tableFeuillePointageTypesAbscencesDivContainer select:not(#pointage_month_selector, #pointage_year_selector)').unbind('change');
                    $('#tableFeuillePointageDivContainer').hide();
                    $('#tableFeuillePointageTypesAbscencesDivContainer').hide();
                }
            });
        }

        // Récupère les mois en fonction du l'utilisateur.
        function ajaxGetMonthByUsername() {
            $('#form_Month').val('');
            $('#form_Month').attr('disabled', true);
            $('#form_Month option').filter(function () {
                return $(this).attr('value') !== '';
            }).remove();
            $('#form_Year').val('');
            $('#form_Year').attr('disabled', true);
            $('#form_Year option').filter(function () {
                return $(this).attr('value') !== '';
            }).remove();
            if ($('#form_User option:selected').val() !== '') {
                $.ajax({
                    type: 'POST',
                    url: '{{ path('nox_intranet_ajax_get_month_by_username') }}',
                    data: {username: $('#form_User option:selected').val()},
                    success: function (response) {
                        if (response.length > 2) {
                            var newOptions = JSON.parse(response);
                            $.each(newOptions, function (key, value) {
                                $('#form_Month').append($("<option/>", {
                                    value: key,
                                    text: value
                                }));
                            });
                            $('#form_Month').removeAttr('disabled');
                        } else {
                            $('#form_Month').attr('disabled', true);
                            $('#form_Year').attr('disabled', true);
                        }
                    }
                });
            } else {
                $('#form_Month').attr('disabled', true);
                $('#form_Year').attr('disabled', true);
            }
        }

        // Récupère les années en fonction de l'utilisateur et du mois.
        function ajaxGetYearByMonthAndUsername() {
            $('#form_Year option:nth-child(n+2)').remove();
            if ($('#form_Month option:selected').val() !== '') {
                $.ajax({
                    type: 'POST',
                    url: '{{ path('nox_intranet_ajax_get_year_by_month_and_username') }}',
                    data: {username: $('#form_User option:selected').val(), month: $('#form_Month option:selected').val()},
                    success: function (response) {
                        if (response.length > 2) {
                            var newOptions = JSON.parse(response);
                            $.each(newOptions, function (key, value) {
                                $('#form_Year').append($("<option/>", {
                                    value: key,
                                    text: value
                                }));
                            });
                            $('#form_Year').removeAttr('disabled');
                        } else {
                            $('#form_Year').attr('disabled', true);
                        }
                    }
                });
            } else {
                $('#form_Year').attr('disabled', true);
            }

        }

        // Récupère la liste d'utilisateurs en fonction du paramètre de la recherche.
        var request;
        function ajaxUsernameSearch() {
            $('#form_Month').attr('disabled', true);
            $('#form_Year').attr('disabled', true);
            if (typeof request !== 'undefined') {
                request.abort();
            }
            $('#form_User').find("option").remove();
            $('#form_User').css('background', "white url('http://" + window.location.hostname + "{{ asset('bundles/noxintranetressources/images/loading.gif') }}" + "') no-repeat center");
            $('#form_User').css('background-size', '25%');
            request = $.ajax({
                //On lui indique le type d'envoie des informations

                type: 'POST',
                //On lui indique le chemin de la fonction

                url: '{{ path('nox_intranet_ajax_get_users_by_username') }}',
                //On lui donne la valeur du choix qu'on a fait, et id est la variable qui va contenir notre valeur, nous la retrouvons dans notre controller

                data: 'username=' + $("#pointerUserSearch").val(),
                //Enfin nous lui disons de remplir notre formulaire avec le resultat  

                success: function (response) {
                    var data = JSON.parse(response);
                    $('#form_User').css('background', 'white');
                    $('#form_User').find("option").remove();
                    $.each(data, function (i, item) {
                        $('#form_User').append(new Option(item, i));
                    });
                    $('#form_User option:nth-child(even)').css('background', 'SeaShell');
                    $('#form_User option').each(function () {
                        $(this).attr('title', $(this).text());
                    });
                }
            });
        }

        // Récupère la feuille de pointage correspondant à l'utilisateur, au mois et à la date.
        function ajaxGetFeuillePointage() {
            $.ajax({
                //On lui indique le type d'envoie des informations

                type: 'POST',
                //On lui indique le chemin de la fonction

                url: '{{ path('nox_intranet_ajax_get_users_by_username') }}',
                //On lui donne la valeur du choix qu'on a fait, et id est la variable qui va contenir notre valeur, nous la retrouvons dans notre controller

                data: {username: $('#form_User option:selected').val(), month: $('#form_Month option:selected').val(), year: $('#form_Year option:selected').val()},
                //Enfin nous lui disons de remplir notre formulaire avec le resultat  

                success: function (response) {

                }
            });
        }

        // Met à jours les cellules des valeurs totals.
        function tableEventHandler() {
            displayDailyProjectsTotalPercentage();
            function displayDailyProjectsTotalPercentage() {
                // Colore en rouge les cellules dont le contenu n'est pas un nombre.
                function checkCellContentValidity(cell) {
                    if (isNaN(parseFloat($(cell).text(), 10)) || parseFloat($(cell).text()) > 100) {
                        if ($(cell).text() !== '') {
                            $(cell).css('background-color', 'red');
                        } else {
                            if ($(cell).attr('contenteditable') === 'true') {
                                $(cell).css('background-color', 'white');
                            } else {
                                $(cell).css('background-color', 'rgb(166,166,166)');
                            }
                        }
                    } else {
                        $(cell).css('background-color', 'white');
                    }
                }

                // Affiche la valeur total des cellules d'une même ligne ou 'Erreur' si celle-ci n'est pas valide.
                function checkTotalValue(cell, total) {
                    if ($(cell).css('background-color') !== 'rgb(166, 166, 166)') {
                        if (isNaN(total) || total > 100) {
                            $(cell).text('Erreur');
                            $(cell).css('background', 'red');
                        } else {
                            $(cell).text(total.toFixed(2));
                            $(cell).css('background', 'white');
                        }
                    }
                }

                $('.dailyTotalPercentageCell').each(function () {
                    var total = 0;
                    $(this).siblings('.projectPercentageCell[contenteditable=true]').each(function () {
                        checkCellContentValidity(this);
                        if ($(this).text() !== '') {
                            total = parseFloat(total, 10) + parseFloat($(this).text(), 10);

                        }
                    });
                    checkTotalValue(this, total);
                });
            }

            dispayMonthlyTotalHoursMod();
            function dispayMonthlyTotalHoursMod() {
                var total = 0;
                var error = false;
                $('.dailyHoursMod').each(function () {
                    if ($(this).css('background-color') !== 'rgb(166, 166, 166)') {
                        if ($(this).text() !== '') {
                            if (Math.floor($(this).text()) == $(this).text() && $.isNumeric($(this).text())) {
                                $(this).css('background-color', 'white');
                                total = parseFloat(total, 10) + parseFloat($(this).text(), 10);
                            } else {
                                $(this).css('background-color', 'red');
                                error = true;
                            }
                        } else {
                            $(this).css('background-color', 'white');
                        }
                    }
                });
                if (error) {
                    $('#monthlyTotalHoursMod').css('background-color', 'red');
                    $('#monthlyTotalHoursMod').text('Erreur');
                } else {
                    $('#monthlyTotalHoursMod').css('background-color', 'white');
                    $('#monthlyTotalHoursMod').text(total.toFixed(2));
                }
            }

            displayMonthlyTotalTitresRepas();
            function displayMonthlyTotalTitresRepas() {
                var total = 0;
                $('.titreRepasNumberSelector select').each(function () {
                    if ($(this).find('option:selected').val() !== '') {
                        total = parseInt(total, 10) + parseInt($(this).find('option:selected').val(), 10);
                    }
                });
                $('#titreRepasTotalNumber').text(total);
            }

            displayMonthlyTotalForfaitsDeplacement();
            function displayMonthlyTotalForfaitsDeplacement() {
                var total = 0;
                $('.forfaitsDeplacementMontant').each(function () {
                    if ($(this).text() !== '') {
                        total = parseFloat(total, 10) + parseFloat($(this).text(), 10);
                    }
                });
                $('#ForfaitDeplacementTotalMontant').text(total.toFixed(2));
            }

            displayMonthlyTotalPrimesPanier();
            function displayMonthlyTotalPrimesPanier() {
                var total = 0;
                $('.primesPanierNumber').each(function () {
                    if ($(this).text() !== '') {
                        total = parseFloat(total, 10) + parseFloat($(this).text(), 10);
                    }
                });
                $('#PrimesPanierTotalNumber').text(total.toFixed(2));
            }

            displayTotalAbscences();
            function displayTotalAbscences() {

                // Calcule le total de chaque type d'abscences et affiche la valeur dans la cellule correspondante.
                function getAbscencesCount(nbAbscencesCell) {
                    var codeAbsences = $(nbAbscencesCell).next().text();
                    var total = 0;

                    $('.abscenceMatinSelector').each(function () {
                        if (codeAbsences === $(this).find('select option:selected').val()) {
                            total = parseFloat(total, 10) + parseFloat(0.5, 10);
                        }
                    });
                    $('.abscenceAMSelector').each(function () {
                        if (codeAbsences === $(this).find('select option:selected').val()) {
                            total = parseFloat(total, 10) + parseFloat(0.5, 10);
                        }
                    });
                    $(nbAbscencesCell).text(total);
                }


                $('.nbAbscences').each(function () {
                    getAbscencesCount(this);
                });
            }

            displayTotalTitreTransport();
            function displayTotalTitreTransport() {
                var total = 0;
                if ($('#titreTransportMontant').text() !== '') {
                    total = parseFloat($('#titreTransportMontant').text(), 10) / 2;
                }
                $('#titreTransportTotalMontant').text(total.toFixed(2));
            }

            onePerkOnly();
            function onePerkOnly() {
                // Lors d'un changement sur les selecteur de titre repas.
                $('.titreRepasNumberSelector select').each(function () {
                    // Si la valeur du sélécteur est à '1'.
                    if ($(this).val() === '1') {
                        // On change la couleur de fond des cases de forfaits déplacement et de primes panier voisines et on bloque leur edition.
                        $(this).parent('.titreRepasNumberSelector').siblings('.abscenceMatinSelector').find('select').val('');
                        $(this).parent('.titreRepasNumberSelector').siblings('.abscenceMatinSelector').find('select').attr('disabled', true);
                        $(this).parent('.titreRepasNumberSelector').siblings('.abscenceAMSelector').find('select').val('');
                        $(this).parent('.titreRepasNumberSelector').siblings('.abscenceAMSelector').find('select').attr('disabled', true);
                        $(this).parent('.titreRepasNumberSelector').siblings('.forfaitsDeplacementMontant').text('');
                        $(this).parent('.titreRepasNumberSelector').siblings('.forfaitsDeplacementMontant').css('background-color', 'rgb(166,166,166)');
                        $(this).parent('.titreRepasNumberSelector').siblings('.primesPanierNumber').text('');
                        $(this).parent('.titreRepasNumberSelector').siblings('.primesPanierNumber').css('background-color', 'rgb(166,166,166)');
                    }
                });

                $('.abscenceMatinSelector select').each(function () {
                    if ($(this).val() !== '') {
                        // On change la couleur de fond des cases de forfaits déplacement et de primes panier voisines et on bloque leur edition.
                        $(this).parent('.abscenceMatinSelector').siblings('.titreRepasNumberSelector').find('select').val('');
                        $(this).parent('.abscenceMatinSelector').siblings('.titreRepasNumberSelector').find('select').attr('disabled', true);
                        $(this).parent('.abscenceMatinSelector').siblings('.forfaitsDeplacementMontant').text('');
                        $(this).parent('.abscenceMatinSelector').siblings('.forfaitsDeplacementMontant').css('background-color', 'rgb(166,166,166)');
                        $(this).parent('.abscenceMatinSelector').siblings('.primesPanierNumber').text('');
                        $(this).parent('.abscenceMatinSelector').siblings('.primesPanierNumber').css('background-color', 'rgb(166,166,166)');
                    }
                });

                $('.abscenceAMSelector select').each(function () {
                    if ($(this).val() !== '') {
                        // On change la couleur de fond des cases de forfaits déplacement et de primes panier voisines et on bloque leur edition.
                        $(this).parent('.abscenceAMSelector').siblings('.titreRepasNumberSelector').find('select').val('');
                        $(this).parent('.abscenceAMSelector').siblings('.titreRepasNumberSelector').find('select').attr('disabled', true);
                        $(this).parent('.abscenceAMSelector').siblings('.forfaitsDeplacementMontant').text('');
                        $(this).parent('.abscenceAMSelector').siblings('.forfaitsDeplacementMontant').css('background-color', 'rgb(166,166,166)');
                        $(this).parent('.abscenceAMSelector').siblings('.primesPanierNumber').text('');
                        $(this).parent('.abscenceAMSelector').siblings('.primesPanierNumber').css('background-color', 'rgb(166,166,166)');
                    }
                });

                // Lorsqu'on écris dans une case de forfait déplacement.
                $('.forfaitsDeplacementMontant').each(function () {
                    // Si la case n'est pas vide.
                    if ($(this).text() !== '') {
                        $(this).siblings('.abscenceMatinSelector').find('select').val('');
                        $(this).siblings('.abscenceMatinSelector').find('select').attr('disabled', true);
                        $(this).siblings('.abscenceAMSelector').find('select').val('');
                        $(this).siblings('.abscenceAMSelector').find('select').attr('disabled', true);
                        $(this).siblings('.titreRepasNumberSelector').find('select').val('');
                        $(this).siblings('.titreRepasNumberSelector').find('select').attr('disabled', true);
                        $(this).siblings('.primesPanierNumber').text('');
                        $(this).siblings('.primesPanierNumber').css('background-color', 'rgb(166,166,166)');
                    }
                });

                // Lorsqu'on écris dans une case de prime panier.
                $('.primesPanierNumber').each(function () {
                    // Si la case n'est pas vide.
                    if ($(this).text() !== '') {
                        $(this).siblings('.abscenceMatinSelector').find('select').val('');
                        $(this).siblings('.abscenceMatinSelector').find('select').attr('disabled', true);
                        $(this).siblings('.abscenceAMSelector').find('select').val('');
                        $(this).siblings('.abscenceAMSelector').find('select').attr('disabled', true);
                        $(this).siblings('.titreRepasNumberSelector').find('select').val('');
                        $(this).siblings('.titreRepasNumberSelector').find('select').attr('disabled', true);
                        $(this).siblings('.forfaitsDeplacementMontant').text('');
                        $(this).siblings('.forfaitsDeplacementMontant').css('background-color', 'rgb(166,166,166)');
                    }
                });
            }
        }

        // Affiche les jours du moi en fonction du mois et de l'année séléctionées.
        function getNewDate() {

            $('#form_User, #form_Month, #form_Year').change(function () {
                $('#form_Pointage').val('');
                if ($('#form_User option:selected').val() !== '' && $('#form_Month option:selected').val() !== '' && $('#form_Year option:selected').val() !== '') {
                    deleteProjectColumn();
                    resetCellsValues();
                    ajaxGetNewDate($('#form_User option:selected').val(), $('#form_Month option:selected').val(), $('#form_Year option:selected').val());
                }
            });

            $('#form_Pointage').change(function () {
                $('#form_User').val('');
                $('#form_Month').val('');
                $('#form_Month').attr('disabled', true);
                $('#form_Month option').filter(function () {
                    return $(this).attr('value') !== '';
                }).remove();
                $('#form_Year').val('');
                $('#form_Year').attr('disabled', true);
                $('#form_Year option').filter(function () {
                    return $(this).attr('value') !== '';
                }).remove();
                deleteProjectColumn();
                resetCellsValues();
                ajaxGetNewDateByPointageNumber();
            });

            // Supprime les colonnes existantes de projets suplémentaires et rétablie le colspan de "Operationnel" à 2.
            function deleteProjectColumn() {

                var firstColumnIndex = $('#tableFeuillePointage tr:nth-child(2) .project').first().index() + 2;
                var lastColumnIndex = $('#tableFeuillePointage tr:nth-child(2) .project').last().index() + 1;
                $('#tableFeuillePointage tr:nth-child(n+2) td:nth-child(n+' + firstColumnIndex + '):nth-child(-n+' + lastColumnIndex + ')').remove();
                $('#operationnel').attr('colspan', 2);
            }

            // Remet à zero les valeurs de cellules.
            function resetCellsValues() {
                $('[contenteditable]').text('');
                $('.project').first().text("Nouvelle Affaire");
                $('.dailyTotalPercentageCell, .monthlyTotalPercentageCell, .monthlyTotalCell, #ForfaitDeplacementTotalMontant, #PrimesPanierTotalNumber, #titreTransportTotalMontant').text(0.00);
                $('#monthlyTotalHoursMod, #titreRepasTotalNumber, .nbAbscences').text(0);
                $('#tableFeuillePointage select:not(#pointage_month_selector, #pointage_year_selector)').val('');
            }

            // Récupère les jours en fonction du moi et de l'année.
            function ajaxGetNewDate(user, month, year) {
                $.ajax({
                    type: 'POST',
                    dataType: 'json',
                    url: '{{ path('nox_intranet_pointage_ajax_set_date') }}',
                    data: {month: $('#form_Month option:selected').val(), year: $('#form_Year option:selected').val()},
                    success: function (response) {

                        // Ajout/supprime des lignes en fonction du nombre de jours du mois.
                        if ($('.dayDateCell').length !== response.length) {
                            var difference = response.length - $('.dayDateCell').length;
                            if (difference > 0) {
                                for (var i = 0; i < difference; i++) {
                                    var lastTr = $('.dayDateCell').last().parent('tr');
                                    lastTr.after(lastTr.clone());
                                }
                            } else if (difference < 0) {
                                for (var i = 0; i < Math.abs(difference); i++) {
                                    var lastTr = $('.dayDateCell').last().parent('tr');
                                    lastTr.remove();
                                }
                            }
                        }

                        // Pour chaque ligne, remplace la date et remplis les cellules avec les valeurs sauvegardées.
                        $('.dayDateCell').each(function (index) {
                            $(this).transition({
                                rotateX: '360deg'
                            }, function () {
                                $(this).css('transform', '');
                            });
                            if (response[index]['date'] === undefined) {
                                $(this).html('');
                                $(this).parent('tr').find('td').css('background', 'white');
                            } else {
                                $(this).html(response[index]['date']);
                                if (response[index]['date'].indexOf('Samedi') >= 0 || response[index]['date'].indexOf('Dimanche') >= 0 || response[index]['ferie'] === true) {
                                    $(this).parent('tr').find('td').css('background', 'rgb(166,166,166)');
                                    $(this).next('td').attr('contenteditable', false);
                                    $(this).siblings('.dailyHoursMod').attr('contenteditable', false);
                                    $(this).siblings('.dailyTotalPercentageCell').html('');
                                    $(this).siblings('.abscenceMatinSelector').html('');
                                    $(this).siblings('.abscenceAMSelector').html('');
                                    $(this).siblings('.titreRepasNumberSelector').html('');
                                    $(this).siblings('.forfaitsDeplacementMontant').attr('contenteditable', false);
                                    $(this).siblings('.primesPanierNumber').attr('contenteditable', false);
                                    $(this).siblings('.comments').attr('contenteditable', true);
                                    $(this).siblings('.comments').css('background', 'white');
                                } else {
                                    $(this).parent('tr').find('td').css('background', 'white');
                                    $(this).next('td').attr('contenteditable', true);
                                    $(this).siblings('.dailyHoursMod').attr('contenteditable', true);
                                    $(this).siblings('.abscenceMatinSelector').html("<select><option value=''></option> <option value='AA'>AA</option><option value='TJ'>TJ</option><option value='AT'>AT</option><option value='MT'>MT</option> <option value='PA'>PA</option> <option value='CS'>CS</option><option value='CP'>CP</option> <option value='AV'>AV</option> <option value='JS'>JS</option> <option value='MA'>MA</option> <option value='PM'>PM</option> <option value='RE'>RE</option> <option value='Autre'>Autre</option></select>");
                                    $(this).siblings('.abscenceAMSelector').html("<select><option value=''></option><option value='AA'>AA</option><option value='TJ'>TJ</option><option value='AT'>AT</option><option value='MT'>MT</option><option value='PA'>PA</option><option value='CS'>CS</option><option value='CP'>CP</option><option value='AV'>AV</option><option value='JS'>JS</option><option value='MA'>MA</option><option value='PM'>PM</option><option value='RE'>RE</option><option value='Autre'>Autre</option></select>");
                                    $(this).siblings('.titreRepasNumberSelector').html("<select><option value=''></option><option value='1'>1</option></select>");
                                    $(this).siblings('.forfaitsDeplacementMontant').attr('contenteditable', true);
                                    $(this).siblings('.primesPanierNumber').attr('contenteditable', true);
                                    $(this).siblings('.comments').attr('contenteditable', true);
                                }
                            }
                        });
                        $('td[contenteditable]').unbind('blur');
                        $('.projet[contenteditable]').unbind('blur');
                        $('#tableFeuillePointage select:not(#pointage_month_selector, #pointage_year_selector)').unbind('change');
                        ajaxGetData(user, month, year);
                    }
                });
            }

            // Récupère les jours en fonction du moi et de l'année définis par la feuille de pointage sélectionnée.
            function ajaxGetNewDateByPointageNumber() {
                $.ajax({
                    type: 'POST',
                    dataType: 'json',
                    url: '{{ path('nox_intranet_pointage_ajax_set_date_by_pointage_number') }}',
                    data: {pointageNumber: $('#form_Pointage option:selected').val()},
                    success: function (response) {

                        // Ajout/supprime des lignes en fonction du nombre de jours du mois.
                        if ($('.dayDateCell').length !== response['dates'].length) {
                            var difference = response['dates'].length - $('.dayDateCell').length;
                            if (difference > 0) {
                                for (var i = 0; i < difference; i++) {
                                    var lastTr = $('.dayDateCell').last().parent('tr');
                                    lastTr.after(lastTr.clone());
                                }
                            } else if (difference < 0) {
                                for (var i = 0; i < Math.abs(difference); i++) {
                                    var lastTr = $('.dayDateCell').last().parent('tr');
                                    lastTr.remove();
                                }
                            }
                        }

                        $('.dayDateCell').each(function (index) {
                            $(this).transition({
                                rotateX: '360deg'
                            }, function () {
                                $(this).css('transform', '');
                            });
                            if (response['dates'][index]['date'] === undefined) {
                                $(this).html('');
                                $(this).parent('tr').find('td').css('background', 'white');
                            } else {
                                console.log(response['dates'][index]['ferie']);
                                $(this).html(response['dates'][index]['date']);
                                if (response['dates'][index]['date'].indexOf('Samedi') >= 0 || response['dates'][index]['date'].indexOf('Dimanche') >= 0 || response['dates'][index]['ferie'] === true) {
                                    $(this).parent('tr').find('td').css('background', 'rgb(166,166,166)');
                                    $(this).next('td').attr('contenteditable', false);
                                    $(this).siblings('.dailyHoursMod').attr('contenteditable', false);
                                    $(this).siblings('.dailyTotalPercentageCell').html('');
                                    $(this).siblings('.abscenceMatinSelector').html('');
                                    $(this).siblings('.abscenceAMSelector').html('');
                                    $(this).siblings('.titreRepasNumberSelector').html('');
                                    $(this).siblings('.forfaitsDeplacementMontant').attr('contenteditable', false);
                                    $(this).siblings('.primesPanierNumber').attr('contenteditable', false);
                                    $(this).siblings('.comments').attr('contenteditable', true);
                                    $(this).siblings('.comments').css('background', 'white');
                                } else {
                                    $(this).parent('tr').find('td').css('background', 'white');
                                    $(this).next('td').attr('contenteditable', true);
                                    $(this).siblings('.dailyHoursMod').attr('contenteditable', true);
                                    $(this).siblings('.abscenceMatinSelector').html("<select><option value=''></option> <option value='AA'>AA</option><option value='TJ'>TJ</option><option value='AT'>AT</option><option value='MT'>MT</option> <option value='PA'>PA</option> <option value='CS'>CS</option><option value='CP'>CP</option> <option value='AV'>AV</option> <option value='JS'>JS</option> <option value='MA'>MA</option> <option value='PM'>PM</option> <option value='RE'>RE</option> <option value='Autre'>Autre</option></select>");
                                    $(this).siblings('.abscenceAMSelector').html("<select><option value=''></option><option value='AA'>AA</option><option value='TJ'>TJ</option><option value='AT'>AT</option><option value='MT'>MT</option><option value='PA'>PA</option><option value='CS'>CS</option><option value='CP'>CP</option><option value='AV'>AV</option><option value='JS'>JS</option><option value='MA'>MA</option><option value='PM'>PM</option><option value='RE'>RE</option><option value='Autre'>Autre</option></select>");
                                    $(this).siblings('.titreRepasNumberSelector').html("<select><option value=''></option><option value='1'>1</option></select>");
                                    $(this).siblings('.forfaitsDeplacementMontant').attr('contenteditable', true);
                                    $(this).siblings('.primesPanierNumber').attr('contenteditable', true);
                                    $(this).siblings('.comments').attr('contenteditable', true);
                                }
                            }
                        });
                        $('td[contenteditable]').unbind('blur');
                        $('.projet[contenteditable]').unbind('blur');
                        $('#tableFeuillePointage select:not(#pointage_month_selector, #pointage_year_selector)').unbind('change');
                        ajaxGetData(response['username'], response['month'], response['year']);
                    }
                });
            }
        }

        // Récupère les données du tableau en base de données et les injectes dans les cellules.
        function ajaxGetData(user, month, year) {
            $.ajax({
                type: 'POST',
                url: '{{ path('nox_intranet_pointage_ajax_get_data_by_username') }}',
                data: {username: user, month: month, year: year},
                success: function (response) {
                    if (response !== '') {
                        var data = JSON.parse(response);
                        // Ajoute un td après chaque td du dernier projet.
                        function addTd() {
                            var total = $('#tableFeuillePointage').find('tr').length;
                            $('#tableFeuillePointage').find('tr').each(function (index) {
                                if (index === 1) {
                                    $(this).find('.project').last().after("<td class='project' style='border-top-width: 1px; border-bottom-width: 1px;' contenteditable=true>Nouvelle Affaire></td>");
                                } else if (index === 2) {
                                    $(this).find('.project').last().after("<td class='project' style='border-top-width: 1px; border-bottom-width: 1px;'>%</td>");
                                } else if (index === total - 2) {
                                    //$('.monthlyTotalPercentageCell').last().css('background-color', 'orange');
                                    $('.monthlyTotalPercentageCell').last().after("<td class='monthlyTotalPercentageCell' style='border: none; color:white;'>0.00</td>");
                                } else if (index === total - 1) {
                                    $('.monthlyTotalCell').last().after("<td class='monthlyTotalCell' style='border: none; color:white;'>0.00</td>");
                                    //$('.monthlyTotalCell').last().css('background-color', 'orange');
                                } else if (index === total - 3) {
                                    $('#titreRepasTotalNumber').before("<td style='border: none;'></td>");
                                    //$('.monthlyTotalCell').last().css('background-color', 'orange');
                                } else if (index > 1 && index < total - 3) {
                                    var background = $(this).find('.project').last().css('background-color');
                                    var contenteditable = $(this).find('.project').last().attr('contenteditable');
                                    //alert(contenteditable);
                                    $(this).find('.project').last().after("<td class='projectPercentageCell project'></td>");
                                    $(this).find('.project').last().css('background-color', background);
                                    $(this).find('.project').last().attr('contenteditable', contenteditable);
                                }
                            });
                        }

                        // Incrémente le colspan du header des projets de 1.
                        function setColSpan() {
                            var colspan = parseInt($('#operationnel').attr('colspan'), 10);
                            $('#operationnel').attr('colspan', colspan + 1);
                        }

                        if (data['nbProject'] !== undefined) {
                            for (var i = 0; i < data['nbProject'] - 1; i++) {
                                addTd();
                                setColSpan();
                            }
                        }

                        $('#signatureCollaborateur').text(data['signatureCollaborateur']);
                        if (data['contenteditable'] !== undefined) {
                            $('td[contenteditable=true]:not(#signatureCollaborateur, .project)').each(function (index) {
                                $(this).text(data['contenteditable'][index]);
                            });
                        }

                        if (data['select'] !== undefined) {
                            $('#tableFeuillePointage select:not(#pointage_month_selector, #pointage_year_selector)').each(function (index) {
                                $(this).val(data['select'][index]);
                            });
                        }

                        if (data['project'] !== undefined) {
                            $('.project[contenteditable=true]').each(function (index) {
                                $(this).text(data['project'][index]);
                            });
                        }

                        deleteProjectColumn();
                        tableEventHandler();
                        displayDailyProjectsTotalPercentage();
                        dispayMonthlyTotalHoursMod();
                        displayMonthlyTotalTitresRepas();
                        displayMonthlyTotalForfaitsDeplacement();
                        displayMonthlyTotalPrimesPanier();
                        displayTotalAbscences();
                        displayTotalTitreTransport();
                        checkAbscencesTitreRepas();
                        ajaxGetPointageStatus(user, month, year);
                    }
                }
            }).done(function () {
                $("#tableFeuillePointage").tableHeadFixer({'head': false, 'left': 1});
                $('#tableFeuillePointageDivContainer').show();
                $('#tableFeuillePointageTypesAbscencesDivContainer').show();
                $('#pointage_month_selector').attr('disabled', true);
                $('#pointage_year_selector').attr('disabled', true);
            });
        }

        // Vérifie le status de la feuille de pointage, colore la barre d'avancement en conséquence et vérouille la feuille si nécessaire.
        function ajaxGetPointageStatus(user, month, year) {
            $('td[contenteditable=true]').css('cursor', 'initial');
            $('td[contenteditable=true]').removeAttr('onkeydown');
            $('select:not(#pointage_month_selector, #pointage_year_selector, #form_User, #form_Month, #form_Year, #form_Pointage)').removeAttr('disabled');
            $('#addProject').show();
            $('#form_Valider').show();

            $('.pointageStatusLine div').width('10%');
            $(".pointageStatusCircle").css('background-color', 'lightgrey');
            $(".pointageStatusCircle").filter(function () {
                return  $(this).attr("step") <= 0;
            }).css('background-color', 'green');
            $.ajax({
                type: 'POST',
                url: '{{ path('nox_intranet_pointage_ajax_get_status') }}',
                data: {username: user, month: month, year: year},
                success: function (response) {
                    var width = null;
                    var cercleNb = null;

                    switch (response) {
                        case '0':
                            width = 10;
                            cercleNb = 0;
                            break;
                        case '1':
                            width = 30;
                            cercleNb = 1;
                            break;
                        case '2':
                            width = 30;
                            cercleNb = 1;
                            break;
                        case '3':
                            width = 50;
                            cercleNb = 2;
                            break;
                        case '4':
                            width = 70;
                            cercleNb = 3;
                            break;
                        case '5':
                            width = 100;
                            cercleNb = 4;
                            break;
                    }


                    $('.pointageStatusLine div').width(width + '%');
                    $(".pointageStatusCircle").filter(function () {
                        return  $(this).attr("step") <= cercleNb;
                    }).css('background-color', 'green');

                    if (response !== '1' && response !== '') {
                        $('td[contenteditable=true]').css('cursor', 'default');
                        $('td[contenteditable=true]').attr('onkeydown', "return false");
                        $('select:not(#pointage_month_selector, #pointage_year_selector, #form_User, #form_Month, #form_Year, #form_Pointage)').attr('disabled', 'disabled');
                        $('#addProject').hide();
                        $('#form_Valider').hide();
                    } else {
                        $('#form_Valider').click(function () {
                            if (confirm('Confirmer la validation de la feuille de pointage ? Celle-ci ne sera plus modifiable.')) {
                                ajaxPointageAssistanteAgenceValidation(user, month, year);
                            }
                        });
                        ajaxSaveData(user, month, year);
                    }
                }
            });

            // Lis le contenu des cellules du tableau et renvoie le résultat sous forme de chaine pour sauvegarde en base de données.
            function ajaxSaveData(user, month, year) {
                $('#tableFeuillePointageDivContainer td[contenteditable=true], #tableFeuillePointageTypesAbscencesDivContainer td[contenteditable=true]').on('blur', function () {
                    var data = {};
                    data['contenteditable'] = [];
                    data['select'] = [];
                    data['project'] = [];
                    data['nbProject'] = $('#tableFeuillePointage tr:nth-child(3) .project').length;

                    $('#tableFeuillePointageDivContainer td[contenteditable=true]:not(#signatureCollaborateur, .project, #ajaxSearchAffairesDiv, #projectDeleteMenu), #tableFeuillePointageTypesAbscencesDivContainer td[contenteditable=true]:not(#signatureCollaborateur, .project, #ajaxSearchAffairesDiv, #projectDeleteMenu)').each(function (index) {
                        data['contenteditable'][index] = $(this).text();
                        //$(this).css('background-color', 'orange');
                        //$(this).text(index);
                    });

                    $('#tableFeuillePointageDivContainer select:not(#pointage_month_selector, #pointage_year_selector)').each(function (index) {
                        data['select'][index] = $(this).val();
                        //$(this).css('background-color', 'orange');
                    });

                    $('.project[contenteditable=true]').each(function (index) {
                        data['project'][index] = $(this).text();
                    });

                    var serializedData = JSON.stringify(data);

                    $.ajax({
                        type: 'POST',
                        url: '{{ path('nox_intranet_pointage_ajax_save_data') }}',
                        data: {user: user, month: month, year: year, data: serializedData, signatureCollaborateur: $('#signatureCollaborateur').text()}
                    });
                });

                $('#tableFeuillePointageDivContainer select:not(#pointage_month_selector, #pointage_year_selector)').change(function () {
                    var data = {};
                    data['contenteditable'] = [];
                    data['select'] = [];
                    data['project'] = [];
                    data['nbProject'] = $('#tableFeuillePointage tr:nth-child(3) .project').length;

                    $('#tableFeuillePointageDivContainer td[contenteditable=true]:not(#signatureCollaborateur, .project, #ajaxSearchAffairesDiv, #projectDeleteMenu), #tableFeuillePointageTypesAbscencesDivContainer td[contenteditable=true]:not(#signatureCollaborateur, .project)').each(function (index) {
                        data['contenteditable'][index] = $(this).text();
                        //$(this).css('background-color', 'orange');
                        //$(this).text(index);
                    });

                    $('#tableFeuillePointageDivContainer select:not(#pointage_month_selector, #pointage_year_selector)').each(function (index) {
                        data['select'][index] = $(this).val();
                        //$(this).css('background-color', 'orange');
                    });

                    $('.project[contenteditable=true]').each(function (index) {
                        data['project'][index] = $(this).text();
                    });

                    var serializedData = JSON.stringify(data);

                    $.ajax({
                        type: 'POST',
                        url: '{{ path('nox_intranet_pointage_ajax_save_data') }}',
                        data: {month: $('#pointage_month_selector option:selected').val(), year: $('#pointage_year_selector option:selected').val(), data: serializedData}
                    });
                });
            }
        }

        // Valide la feuille de pointage d'un collaborateur et sauvegarde les données d'absence, de titres repas, de forfaits déplacement, de primes panier et de titre de transport.
        function ajaxPointageAssistanteAgenceValidation(user, month, year) {

            // Retourne les absences du mois.
            function getAbsences() {

                var absences = {'matin': getAbscenceMatin(), 'am': getAbscenceAM()};

                // Retourne les absences du matin par dates et les commentaires.
                function getAbscenceMatin() {
                    var absencesMatin = [];
                    $('.abscenceMatinSelector').each(function () {
                        var jour = $(this).siblings('.dayDateCell').text().slice(-2);
                        var mois = month;
                        if (mois < 10) {
                            var mois = '0' + mois;
                        }
                        var annee = year;
                        var absenceMatin = {};
                        absenceMatin['valeur'] = $(this).children('select').val();
                        absenceMatin['date'] = jour + '-' + mois + '-' + annee;
                        absenceMatin['commentaires'] = $(this).siblings('.comments').text();
                        absencesMatin.push(absenceMatin);
                    });

                    return absencesMatin;
                }

                // Retourne les absences de l'après-midi par dates.
                function getAbscenceAM() {
                    var absencesAM = [];
                    $('.abscenceAMSelector').each(function () {
                        var jour = $(this).siblings('.dayDateCell').text().slice(-2);
                        var mois = month;
                        if (mois < 10) {
                            var mois = '0' + mois;
                        }
                        var annee = year;
                        var absenceAM = {};
                        absenceAM['valeur'] = $(this).children('select').val();
                        absenceAM['date'] = jour + '-' + mois + '-' + annee;
                        absencesAM.push(absenceAM);
                    });

                    return absencesAM;
                }

                return JSON.stringify(absences);
            }

            //Retourne le nombre total de titre repas du mois.
            function getTitresRepas() {
                return $('#titreRepasTotalNumber').text();
            }

            //Retourne le nombre total de forfaits déplacement du mois.
            function getForfaitsDeplacement() {
                return $('#ForfaitDeplacementTotalMontant').text();
            }

            //Retourne le nombre total de primes panier du mois.
            function getPrimesPanier() {
                return $('#PrimesPanierTotalNumber').text();
            }

            //Retourne le nombre total de titre de transport du mois.
            function getTitreTransport() {
                return $('#titreTransportTotalMontant').text();
            }

            $.ajax({
                type: 'POST',
                url: '{{ path('nox_intranet_pointage_ajax_assistante_agence_validation') }}',
                data: {username: user, month: month, year: year, absences: getAbsences(), titresRepas: getTitresRepas(), forfaitsDeplacement: getForfaitsDeplacement(), primesPanier: getPrimesPanier(), titreTransport: getTitreTransport()},
                success: function () {
                    location.reload();
                }
            });
        }

        // Calcule et affiche le pourcentage total de chaque ligne de projets et vérifie la validité des donnnées.
        function displayDailyProjectsTotalPercentage() {

            // Colore en rouge les cellules dont le contenu n'est pas un nombre.
            function checkCellContentValidity(cell) {
                if (isNaN(parseFloat($(cell).text(), 10)) || parseFloat($(cell).text(), 10) > 100) {
                    if ($(cell).text() !== '') {
                        $(cell).css('background', 'red');
                    } else {
                        $(cell).css('background', 'white');
                    }

                } else {
                    $(cell).css('background', 'white');
                }
            }

            // Affiche la valeur total des cellules d'une même ligne ou 'Erreur' si celle-ci n'est pas valide.
            function checkTotalValue(cell, total) {
                if ($(cell).css('background-color') !== 'rgb(166, 166, 166)') {
                    if (isNaN(total) || total > 100) {
                        $(cell).text('Erreur');
                        $(cell).css('background', 'red');
                    } else {
                        $(cell).text(total.toFixed(2));
                        $(cell).css('background', 'white');
                    }
                }
            }

            $('.projectPercentageCell').on('blur keyup paste input', function () {
                $('.dailyTotalPercentageCell').each(function () {
                    var total = 0;
                    $(this).siblings('.projectPercentageCell[contenteditable=true]').each(function () {
                        checkCellContentValidity(this);
                        if ($(this).text() !== '') {
                            total = parseFloat(total, 10) + parseFloat($(this).text(), 10);
                        }
                    });
                    checkTotalValue(this, total);
                });
            });

        }

        // Calcule et affiche le nombre d'heure total pour le mois courant.
        function dispayMonthlyTotalHoursMod() {
            $('.dailyHoursMod').on('blur keyup paste input', function () {
                var total = 0;
                var error = false;
                $('.dailyHoursMod').each(function () {
                    if ($(this).css('background-color') !== 'rgb(166, 166, 166)') {
                        if ($(this).text() !== '') {
                            if (Math.floor($(this).text()) == $(this).text() && $.isNumeric($(this).text())) {
                                $(this).css('background-color', 'white');
                                total = parseFloat(total, 10) + parseFloat($(this).text(), 10);
                            } else {
                                $(this).css('background-color', 'red');
                                error = true;
                            }
                        } else {
                            $(this).css('background-color', 'white');
                        }
                    }
                });
                if (error) {
                    $('#monthlyTotalHoursMod').css('background-color', 'red');
                    $('#monthlyTotalHoursMod').text('Erreur');
                } else {
                    $('#monthlyTotalHoursMod').css('background-color', 'white');
                    $('#monthlyTotalHoursMod').text(total.toFixed(2));
                }
            });
        }

        // Calcule et affiche le nombre total de titres repas pour le mois courant.
        function displayMonthlyTotalTitresRepas() {
            $('.titreRepasNumberSelector select, .abscenceMatinSelector select, .abscenceAMSelector select').change(function () {
                var total = 0;
                $('.titreRepasNumberSelector select').each(function () {
                    if ($(this).find('option:selected').val() !== '') {
                        total = parseInt(total, 10) + parseInt($(this).find('option:selected').val(), 10);
                    }
                });
                $('#titreRepasTotalNumber').text(total);
            });
        }

        // Met à zéro et désactive le selecteur de titre repas lorsque le nombre d'abscence dépasse 0.
        function checkAbscencesTitreRepas() {
            $('.abscenceMatinSelector').on('change', 'select', function () {
                if ($(this).val() !== '' || $(this).parent('.abscenceMatinSelector').siblings('.abscenceAMSelector').find('select').val() !== '') {
                    $(this).parent('.abscenceMatinSelector').siblings('.titreRepasNumberSelector').find('select').val('');
                    $(this).parent('.abscenceMatinSelector').siblings('.titreRepasNumberSelector').find('select').attr('disabled', true);
                    $(this).parent('.abscenceMatinSelector').siblings('.forfaitsDeplacementMontant').text('');
                    $(this).parent('.abscenceMatinSelector').siblings('.forfaitsDeplacementMontant').css('background-color', 'rgb(166,166,166)');
                    $(this).parent('.abscenceMatinSelector').siblings('.primesPanierNumber').text('');
                    $(this).parent('.abscenceMatinSelector').siblings('.primesPanierNumber').css('background-color', 'rgb(166,166,166)');
                } else {
                    $(this).parent('.abscenceMatinSelector').siblings('.titreRepasNumberSelector').find('select').removeAttr('disabled');
                    $(this).parent('.abscenceMatinSelector').siblings('.forfaitsDeplacementMontant').css('background-color', 'white');
                    $(this).parent('.abscenceMatinSelector').siblings('.primesPanierNumber').css('background-color', 'white');
                }
            });
            $('.abscenceAMSelector').on('change', 'select', function () {
                if ($(this).val() !== '' || $(this).parent('.abscenceAMSelector').siblings('.abscenceMatinSelector').find('select').val() !== '') {
                    $(this).parent('.abscenceAMSelector').siblings('.titreRepasNumberSelector').find('select').val('');
                    $(this).parent('.abscenceAMSelector').siblings('.titreRepasNumberSelector').find('select').attr('disabled', true);
                    $(this).parent('.abscenceAMSelector').siblings('.forfaitsDeplacementMontant').text('');
                    $(this).parent('.abscenceAMSelector').siblings('.forfaitsDeplacementMontant').css('background-color', 'rgb(166,166,166)');
                    $(this).parent('.abscenceAMSelector').siblings('.primesPanierNumber').text('');
                    $(this).parent('.abscenceAMSelector').siblings('.primesPanierNumber').css('background-color', 'rgb(166,166,166)');
                } else {
                    $(this).parent('.abscenceAMSelector').siblings('.titreRepasNumberSelector').find('select').removeAttr('disabled');
                    $(this).parent('.abscenceAMSelector').siblings('.forfaitsDeplacementMontant').css('background-color', 'white');
                    $(this).parent('.abscenceAMSelector').siblings('.primesPanierNumber').css('background-color', 'white');
                }
            });
        }

        // Vérifie qu'une seule option est renseignée parmis les titres repas, la prime panier ou le forfait déplacement pour chaque jours.
        function onePerkOnly() {
            // Lors d'un changement sur les selecteur de titre repas.
            $('.titreRepasNumberSelector').on('change', 'select', function () {
                // Si la valeur du sélécteur est à '1'.
                if ($(this).val() === '1') {
                    // On change la couleur de fond des cases de forfaits déplacement et de primes panier voisines et efface leur valeurs.
                    $(this).parent('.titreRepasNumberSelector').siblings('.abscenceMatinSelector').find('select').val('');
                    $(this).parent('.titreRepasNumberSelector').siblings('.abscenceMatinSelector').find('select').attr('disabled', true);
                    $(this).parent('.titreRepasNumberSelector').siblings('.abscenceAMSelector').find('select').val('');
                    $(this).parent('.titreRepasNumberSelector').siblings('.abscenceAMSelector').find('select').attr('disabled', true);
                    $(this).parent('.titreRepasNumberSelector').siblings('.forfaitsDeplacementMontant').text('');
                    $(this).parent('.titreRepasNumberSelector').siblings('.forfaitsDeplacementMontant').css('background-color', 'rgb(166,166,166)');
                    $(this).parent('.titreRepasNumberSelector').siblings('.primesPanierNumber').text('');
                    $(this).parent('.titreRepasNumberSelector').siblings('.primesPanierNumber').css('background-color', 'rgb(166,166,166)');
                }
                // On change la couleur de fond des cases de forfaits déplacement et de primes panier voisines.
                else {
                    $(this).parent('.titreRepasNumberSelector').siblings('.forfaitsDeplacementMontant').css('background-color', 'white');
                    $(this).parent('.titreRepasNumberSelector').siblings('.primesPanierNumber').css('background-color', 'white');
                    $(this).parent('.titreRepasNumberSelector').siblings('.abscenceMatinSelector').find('select').attr('disabled', false);
                    $(this).parent('.titreRepasNumberSelector').siblings('.abscenceAMSelector').find('select').attr('disabled', false);
                }
            });

            // Lorsqu'on écris dans une case de forfait déplacement.
            $('.forfaitsDeplacementMontant').keyup(function () {
                // Si la case n'est pas vide.
                if ($(this).text() !== '') {
                    $(this).css('background-color', 'white');
                    $(this).siblings('.abscenceMatinSelector').find('select').val('');
                    $(this).siblings('.abscenceMatinSelector').find('select').attr('disabled', true);
                    $(this).siblings('.abscenceAMSelector').find('select').val('');
                    $(this).siblings('.abscenceAMSelector').find('select').attr('disabled', true);
                    $(this).siblings('.titreRepasNumberSelector').find('select').val('');
                    $(this).siblings('.titreRepasNumberSelector').find('select').attr('disabled', true);
                    $(this).siblings('.primesPanierNumber').text('');
                    $(this).siblings('.primesPanierNumber').css('background-color', 'rgb(166,166,166)');
                }
                // Si la case est vide.
                else {
                    $(this).siblings('.abscenceMatinSelector').find('select').attr('disabled', false);
                    $(this).siblings('.abscenceAMSelector').find('select').attr('disabled', false);
                    $(this).siblings('.titreRepasNumberSelector').find('select').attr('disabled', false);
                    $(this).siblings('.primesPanierNumber').css('background-color', 'white');
                }

                // On met le total des titres repas à jours.
                var total = 0;
                $('.titreRepasNumberSelector select').each(function () {
                    if ($(this).find('option:selected').val() !== '') {
                        total = parseInt(total, 10) + parseInt($(this).find('option:selected').val(), 10);
                    }
                });
                $('#titreRepasTotalNumber').text(total);
            });

            // Lorsqu'on écris dans une case de prime panier.
            $('.primesPanierNumber').keyup(function () {
                // Si la case n'est pas vide.
                if ($(this).text() !== '') {
                    $(this).css('background-color', 'white');
                    $(this).siblings('.abscenceMatinSelector').find('select').val('');
                    $(this).siblings('.abscenceMatinSelector').find('select').attr('disabled', true);
                    $(this).siblings('.abscenceAMSelector').find('select').val('');
                    $(this).siblings('.abscenceAMSelector').find('select').attr('disabled', true);
                    $(this).siblings('.titreRepasNumberSelector').find('select').val('');
                    $(this).siblings('.titreRepasNumberSelector').find('select').attr('disabled', true);
                    $(this).siblings('.forfaitsDeplacementMontant').text('');
                    $(this).siblings('.forfaitsDeplacementMontant').css('background-color', 'rgb(166,166,166)');
                }
                // Si la case est vide.
                else {
                    $(this).siblings('.abscenceMatinSelector').find('select').attr('disabled', false);
                    $(this).siblings('.abscenceAMSelector').find('select').attr('disabled', false);
                    $(this).siblings('.titreRepasNumberSelector').find('select').attr('disabled', false);
                    $(this).siblings('.forfaitsDeplacementMontant').css('background-color', 'white');
                }

                // On met le total des titres repas à jours.
                var total = 0;
                $('.titreRepasNumberSelector select').each(function () {
                    if ($(this).find('option:selected').val() !== '') {
                        total = parseInt(total, 10) + parseInt($(this).find('option:selected').val(), 10);
                    }
                });
                $('#titreRepasTotalNumber').text(total);
            });
        }

        // Calcule et affiche le montant total du forfaits de déplacement pour le mois courant.
        function displayMonthlyTotalForfaitsDeplacement() {
            $('.forfaitsDeplacementMontant').on('blur keyup paste input', function () {
                var total = 0;
                $('.forfaitsDeplacementMontant').each(function () {
                    if ($(this).text() !== '') {
                        total = parseFloat(total, 10) + parseFloat($(this).text(), 10);
                    }
                });
                $('#ForfaitDeplacementTotalMontant').text(total.toFixed(2));
            });
        }

        // Calcule et affiche le montant total des primes de panier pour le mois courant.
        function displayMonthlyTotalPrimesPanier() {
            $('.primesPanierNumber').on('blur keyup paste input', function () {
                var total = 0;
                $('.primesPanierNumber').each(function () {
                    if ($(this).text() !== '') {
                        total = parseFloat(total, 10) + parseFloat($(this).text(), 10);
                    }
                });
                $('#PrimesPanierTotalNumber').text(total.toFixed(2));
            });
        }

        // Calcule et affiche le nombre total de chaque type d'abscences.
        function displayTotalAbscences() {

            // Calcule le total de chaque type d'abscences et affiche la valeur dans la cellule correspondante.
            function getAbscencesCount(nbAbscencesCell) {
                var codeAbsences = $(nbAbscencesCell).next().text();
                var total = 0;

                $('.abscenceMatinSelector').each(function () {
                    if (codeAbsences === $(this).find('select option:selected').val()) {
                        total = parseFloat(total, 10) + parseFloat(0.5, 10);
                    }
                });
                $('.abscenceAMSelector').each(function () {
                    if (codeAbsences === $(this).find('select option:selected').val()) {
                        total = parseFloat(total, 10) + parseFloat(0.5, 10);
                    }
                });
                $(nbAbscencesCell).text(total);
            }

            $('.abscenceMatinSelector select, .abscenceAMSelector select').change(function () {
                $('.nbAbscences').each(function () {
                    getAbscencesCount(this);
                });
            });
        }

        // Calcule le montant de remboursement des titres de tranport.
        function displayTotalTitreTransport() {
            $('#titreTransportMontant').on('blur keyup paste input', function () {
                var total = 0;
                if ($('#titreTransportMontant').text() !== '') {
                    total = parseFloat($('#titreTransportMontant').text(), 10) / 2;
                }
                $('#titreTransportTotalMontant').text(total.toFixed(2));
            });
        }

        // Ajout une nouvelle colonne de projet au tableau.
        function addProjectColumn() {
            $('#addProject').click(function () {
                addTd();
                setColSpan();
                ajaxSaveData();
                deleteProjectColumn();
            });

            // Ajoute un td après chaque td du dernier projet.
            function addTd() {
                var total = $('#tableFeuillePointage').find('tr').length;
                $('#tableFeuillePointage').find('tr').each(function (index) {
                    if (index === 1) {
                        $(this).find('.project').last().after("<td class='project' style='border-top-width: 1px; border-bottom-width: 1px;' contenteditable=true>Nouvelle Affaire</td>");
                    } else if (index === 2) {
                        $(this).find('.project').last().after("<td class='project' style='border-top-width: 1px; border-bottom-width: 1px;'>%</td>");
                    } else if (index === total - 2) {
                        //$('.monthlyTotalPercentageCell').last().css('background-color', 'orange');
                        $('.monthlyTotalPercentageCell').last().after("<td class='monthlyTotalPercentageCell' style='border: none; color:white;'>0.00</td>");
                    } else if (index === total - 1) {
                        $('.monthlyTotalCell').last().after("<td class='monthlyTotalCell' style='border: none; color:white;'>0.00</td>");
                        //$('.monthlyTotalCell').last().css('background-color', 'orange');
                    } else if (index === total - 3) {
                        $('#titreRepasTotalNumber').before("<td style='border: none;'></td>");
                        //$('.monthlyTotalCell').last().css('background-color', 'orange');
                    } else if (index > 1 && index < total - 3) {
                        var background = $(this).find('.project').last().css('background-color');
                        var contenteditable = $(this).find('.project').last().attr('contenteditable');
                        //alert(contenteditable);
                        $(this).find('.project').last().after("<td class='projectPercentageCell project'></td>");
                        $(this).find('.project').last().css('background-color', background);
                        $(this).find('.project').last().attr('contenteditable', contenteditable);
                    }
                });
            }

            // Incrémente le colspan du header des projets de 1.
            function setColSpan() {
                var colspan = parseInt($('#operationnel').attr('colspan'), 10);
                $('#operationnel').attr('colspan', colspan + 1);
            }

            // Lis le contenu des cellules du tableau et renvoie le résultat sous forme de chaine pour sauvegarde en base de données.
            function ajaxSaveData() {
                var data = {};
                data['contenteditable'] = [];
                data['select'] = [];
                data['project'] = [];
                data['nbProject'] = $('#tableFeuillePointage tr:nth-child(3) .project').length;

                $('td[contenteditable=true]:not(#signatureCollaborateur, .project, #ajaxSearchAffairesDiv, #projectDeleteMenu)').each(function (index) {
                    data['contenteditable'][index] = $(this).text();
                });

                $('select:not(#pointage_month_selector, #pointage_year_selector)').each(function (index) {
                    data['select'][index] = $(this).val();
                });

                $('.project[contenteditable=true]').each(function (index) {
                    data['project'][index] = $(this).text();
                });

                var serializedData = JSON.stringify(data);

                $.ajax({
                    type: 'POST',
                    url: '{{ path('nox_intranet_pointage_ajax_save_data') }}',
                    data: {month: $('#pointage_month_selector option:selected').val(), year: $('#pointage_year_selector option:selected').val(), data: serializedData, signatureCollaborateur: $('#signatureCollaborateur').text()}
                });

                $('td[contenteditable]').unbind('blur');
                $('td[contenteditable=true]').on('blur', function () {
                    var data = {};
                    data['contenteditable'] = [];
                    data['select'] = [];
                    data['project'] = [];
                    data['nbProject'] = $('#tableFeuillePointage tr:nth-child(3) .project').length;

                    $('td[contenteditable=true]:not(#signatureCollaborateur, .project, #ajaxSearchAffairesDiv, #projectDeleteMenu)').each(function (index) {
                        data['contenteditable'][index] = $(this).text();
                        //$(this).css('background-color', 'orange');
                        //$(this).text(index);
                    });

                    $('select:not(#pointage_month_selector, #pointage_year_selector)').each(function (index) {
                        data['select'][index] = $(this).val();
                        //$(this).css('background-color', 'orange');
                    });

                    $('.project[contenteditable=true]').each(function (index) {
                        data['project'][index] = $(this).text();
                    });

                    var serializedData = JSON.stringify(data);

                    $.ajax({
                        type: 'POST',
                        url: '{{ path('nox_intranet_pointage_ajax_save_data') }}',
                        data: {month: $('#pointage_month_selector option:selected').val(), year: $('#pointage_year_selector option:selected').val(), data: serializedData, signatureCollaborateur: $('#signatureCollaborateur').text()}
                    });
                });

                displayDailyProjectsTotalPercentage();
                dispayMonthlyTotalHoursMod();
                displayMonthlyTotalTitresRepas();
                displayMonthlyTotalForfaitsDeplacement();
                displayMonthlyTotalPrimesPanier();
                displayTotalAbscences();
                displayTotalTitreTransport();
                checkAbscencesTitreRepas();
                getGXAffaires();
            }
        }

        // Supprime une colonne de projet au tableau.
        function deleteProjectColumn() {

            // On supprime le trigger de contextmenu déjà existant.
            $('#tableFeuillePointage tr:nth-child(2) .project').unbind('contextmenu');

            // Lors d'un clic droit sur une cellule de nom d'affaire.
            $('#tableFeuillePointage tr:nth-child(2) .project').bind('contextmenu', function (e) {

                var projectCellule = $(this);

                // On supprime le trigger de clique déjà existant.
                $('#projectDeleteMenu').unbind('click');

                // On bloque l'apparition du menu contextuel.
                e.preventDefault();

                // On récupére les coordonnées du pointeur de la souris.
                var cursorY = 1.01 * e.pageY;
                var cursorX = 1.01 * e.pageX;

                // Si le nombre d'affaire est supérieur à 1.
                if ($('#tableFeuillePointage tr:nth-child(2) .project').length > 1) {
                    // On positione et fait apparaître le menu de suppression.
                    $('#projectDeleteMenu').css('top', cursorY);
                    $('#projectDeleteMenu').css('left', cursorX);
                    $('#projectDeleteMenu').css('display', 'inline-block');

                    // On supprime les events sur la cellule.
                    //projectCellule.unbind('blur');
                    //projectCellule.unbind('keyup');
                    //projectCellule.unbind('paste');

                    // Lors du clic sur le menu de suppression.
                    $('#projectDeleteMenu').click(function () {
                        $('#projectDeleteMenu').hide();
                        deleteTd(projectCellule);
                        setColSpan();
                        ajaxSaveData2();
                        //console.log($._data(projectCellule[0], "events"));
                    });
                }

                // Si on clique en dehors de la fenêtre de suppression, elle disparaît.
                $(document).mouseup(function (e) {
                    var container = $('#projectDeleteMenu');
                    if (!container.is(e.target) // if the target of the click isn't the container...
                            && container.has(e.target).length === 0) // ... nor a descendant of the container
                    {
                        container.hide();
                        ajaxSaveData2();
                        getGXAffaires();
                    }

                });
            });

            // Supprime les td de la colonne.
            function deleteTd(column) {
                var cellIndex = $(column).index() - 1;
                $('#tableFeuillePointage tr').each(function () {
                    $(this).find('.project').eq(cellIndex).remove();
                });
                $('#tableFeuillePointage tr:nth-last-child(3) td').eq(cellIndex).remove();
                $('.monthlyTotalPercentageCell').eq($(column).index() - 1).remove();
                $('.monthlyTotalCell').eq($(column).index() - 1).remove();
            }

            // Désincrémente le colspan du header des projets de 1.
            function setColSpan() {
                var colspan = parseInt($('#operationnel').attr('colspan'), 10);
                $('#operationnel').attr('colspan', colspan - 1);
            }

            // Lis le contenu des cellules du tableau et renvoie le résultat sous forme de chaine pour sauvegarde en base de données.
            function ajaxSaveData2() {
                var data = {};
                data['contenteditable'] = [];
                data['select'] = [];
                data['project'] = [];
                data['nbProject'] = $('#tableFeuillePointage tr:nth-child(3) .project').length;
                $('td[contenteditable=true]:not(#signatureCollaborateur, .project, #ajaxSearchAffairesDiv, #projectDeleteMenu)').each(function (index) {
                    data['contenteditable'][index] = $(this).text();
                });
                $('select:not(#pointage_month_selector, #pointage_year_selector)').each(function (index) {
                    data['select'][index] = $(this).val();
                });
                $('.project[contenteditable=true]').each(function (index) {
                    data['project'][index] = $(this).text();
                });
                var serializedData = JSON.stringify(data);
                $.ajax({
                    type: 'POST',
                    url: '{{ path('nox_intranet_pointage_ajax_save_data') }}',
                    data: {month: $('#pointage_month_selector option:selected').val(), year: $('#pointage_year_selector option:selected').val(), data: serializedData, signatureCollaborateur: $('#signatureCollaborateur').text()}
                });
                $('td[contenteditable]').unbind('blur');
                $('td[contenteditable=true]').on('blur', function () {
                    var data = {};
                    data['contenteditable'] = [];
                    data['select'] = [];
                    data['project'] = [];
                    data['nbProject'] = $('#tableFeuillePointage tr:nth-child(3) .project').length;
                    $('td[contenteditable=true]:not(#signatureCollaborateur, .project)').each(function (index) {
                        data['contenteditable'][index] = $(this).text();
                        //$(this).css('background-color', 'orange');
                        //$(this).text(index);
                    });
                    $('select:not(#pointage_month_selector, #pointage_year_selector)').each(function (index) {
                        data['select'][index] = $(this).val();
                        //$(this).css('background-color', 'orange');
                    });
                    $('.project[contenteditable=true]').each(function (index) {
                        data['project'][index] = $(this).text();
                    });
                    var serializedData = JSON.stringify(data);
                    $.ajax({
                        type: 'POST',
                        url: '{{ path('nox_intranet_pointage_ajax_save_data') }}',
                        data: {month: $('#pointage_month_selector option:selected').val(), year: $('#pointage_year_selector option:selected').val(), data: serializedData, signatureCollaborateur: $('#signatureCollaborateur').text()}
                    });
                });
                displayDailyProjectsTotalPercentage();
                dispayMonthlyTotalHoursMod();
                displayMonthlyTotalTitresRepas();
                displayMonthlyTotalForfaitsDeplacement();
                displayMonthlyTotalPrimesPanier();
                displayTotalAbscences();
                displayTotalTitreTransport();
                checkAbscencesTitreRepas();
            }
        }

        // Vérifie si le navigateur utilisé est Internet Explorer et affiche un message d'erreur dans ce cas.
        function IECheck() {

            var ms_ie = false;
            var ua = window.navigator.userAgent;
            var old_ie = ua.indexOf('MSIE ');
            var new_ie = ua.indexOf('Trident/');

            if ((old_ie > -1) || (new_ie > -1)) {
                ms_ie = true;
            }

            if (ms_ie) {
                alert('Le module de pointage n\'est pas compatible avec Internet Explorer, veuillez utiliser Google Chrome ou Microsoft Edge à la place.');
            }
        }

        // Renvoi les affaires dont le numéro contient la chaine "search".
        function getGXAffaires() {

            // Supprime les triggers d'event déjà existant.
            $('#tableFeuillePointage tr:nth-child(2) .project').unbind('blur');
            $('#tableFeuillePointage tr:nth-child(2) .project').unbind('keyup');
            $('#tableFeuillePointage tr:nth-child(2) .project').unbind('paste');
            //$('#tableFeuillePointage tr:nth-child(2) .project').unbind('input');

            // Pour toutes action dans une cellule titre d'affaire.
            $('#tableFeuillePointage tr:nth-child(2) .project').on('blur keyup paste', function () {

                $('#ajaxSearchAffairesDiv').hide();

                var search = $(this).text();
                var celluleProject = $(this);
                var affaires = "http://" + window.location.hostname + "/Symfony/web/DatabasesCSV/AffairesEncode.csv";
                var compteur = 0;

                // Supprime les paragraphes de résultats existants.
                $('#ajaxSearchAffairesDiv').empty();

                // Fixe la largeur minimale de la 'div' des résultats a 1.1 fois la taille de la cellule.
                var minWidth = celluleProject.outerWidth() * 1.1;
                $('#ajaxSearchAffairesDiv').css('min-width', minWidth);

                // Cherche la chaine saisi dans le fichier csv des affaires et ajoute une balise 'p' par résultats.
                if (search !== '') {
                    $.get(affaires, function (data) {
                        var lineByLine = data.split("\n");
                        var numsAffaires = [];

                        $.each(lineByLine, function (index, value) {
                            var donnes = value.split(';');
                            numsAffaires.push(donnes[0]);
                            if (compteur < 10 && donnes[0].indexOf(search) >= 0 && (search.trim() !== donnes[0].trim())) {
                                $('#ajaxSearchAffairesDiv').append("<p class='ajaxSearchAffairesDivResults' data-numaffaire='" + donnes[0] + "' style='background-color: white; text-align: center; margin: 0; padding: 0.5vw 0.5vw 0.5vw 0.5vw;'>" + donnes[0] + " " + donnes[1] + "</p>");
                                compteur++;
                            }
                        });

                        // Effet visuel au passage de la souris sur les résultats.
                        $('.ajaxSearchAffairesDivResults').hover(function () {
                            $(this).css('background-color', 'rgb(217, 217, 217)');
                        }, function () {
                            $(this).css('background-color', 'white');
                        });

                        // Lors du clique sur un résultat on remplace le contenu de la recherche par le résultat.
                        $('.ajaxSearchAffairesDivResults').mousedown(function () {
                            celluleProject.text($(this).attr('data-numaffaire'));
                        });

                        // Positione la 'div' contenant les résultats sous la cellules focus.
                        $('#ajaxSearchAffairesDiv').css('top', celluleProject.offset().top + celluleProject.outerHeight() - $('#tableFeuillePointageDivContainer').offset().top);
                        $('#ajaxSearchAffairesDiv').css('left', celluleProject.offset().left - $('#tableFeuillePointageDivContainer').offset().left);

                        // Affiche la 'div' des résultats si elle n'est pas vide.
                        if (compteur > 0) {
                            $('#ajaxSearchAffairesDiv').show();
                        }

                        // Cache la div des résultats lors du blur du champ de recherche et vide la cellule si le contenu n'est pas un numéro d'affaire existant.
                        celluleProject.blur(function () {
                            $('#ajaxSearchAffairesDiv').empty();
                            $('#ajaxSearchAffairesDiv').hide();

                            if ($.inArray(celluleProject.text(), numsAffaires) === -1) {
                                celluleProject.text('');
                                //celluleProject.trigger('blur');
                            }
                        });
                    });
                }

            });
        }

        // Affiche le nom de l'affaire correspondant au numéro survollé par la souris.
        function showAffaireName() {

            // Lorsqu'on passe la souris sur une cellule de numéro d'affaire.
            $('#tableFeuillePointage tr:nth-child(2)').on('mouseover', '.project', function () {

                //On supprime la tooltip.
                $('#tooltipAffaire').remove();

                var celluleAffaire = $(this); // Récupére la cellule d'affaire courante.
                var top = celluleAffaire.offset().top; // Récupére la position verticale de la cellule de l'affaire.
                var left = celluleAffaire.offset().left; // Récupére la position horizontale de la cellule de l'affaire.
                var affaires = "http://" + window.location.hostname + "/Symfony/web/DatabasesCSV/AffairesEncode.csv"; // Récupére le fichier contenant les affaires.
                var numAffaire = celluleAffaire.text(); // Récupére le numéro d'affaire.
                var nomAffaire = ''; // Initialise le nom d'affaire.       

                // On cherche le nom d'affaire correspondant au numéro dans le fichier des affaires.
                $.get(affaires, function (data) {
                    var lineByLine = data.split("\n");

                    $.each(lineByLine, function (index, value) {
                        var donnes = value.split(';');
                        if (numAffaire === donnes[0]) {
                            nomAffaire = donnes[1];
                            return false;
                        }
                    });

                    // Code html de la tooltip.
                    var tooltip = '';
                    tooltip += "<div id='tooltipAffaire' style='display: inline-block; padding: 0%; position: absolute; background-color: rgba(255, 0, 0, 0.8); border-radius: 6px; z-index: 3;'>";
                    tooltip += "<p style='text-align: center; color: white; font-size: 0.8vw; margin-left: 5%; margin-right: 5%;'>";
                    if (nomAffaire) {
                        tooltip += nomAffaire;
                        tooltip += "<br />";
                    }
                    tooltip += "(Cliquez-droit sur l'affaire pour la supprimer.)";
                    tooltip += "</p>";
                    tooltip += '</div>';

                    // On fait apparaître et on positionne la tooltip.
                    $('body').append(tooltip);
                    $('#tooltipAffaire').css('top', top - $('#tooltipAffaire').outerHeight() - 5);
                    $('#tooltipAffaire').css('left', left - ($('#tooltipAffaire').outerWidth() - celluleAffaire.outerWidth()) / 2);
                });
            });

            // Lorsqu'on retire la souris d'une cellule de numéro d'affaire.
            $('#tableFeuillePointage tr:nth-child(2)').on('mouseout', '.project', function () {
                //On supprime la tooltip.
                $('#tooltipAffaire').remove();
            });
        }

    </script>
{% endblock %}